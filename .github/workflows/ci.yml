name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Install shfmt
        run: |
          SHFMT_VERSION=3.8.0
          curl -fsSL "https://github.com/mvdan/sh/releases/download/v${SHFMT_VERSION}/shfmt_v${SHFMT_VERSION}_linux_amd64" -o /usr/local/bin/shfmt
          chmod +x /usr/local/bin/shfmt

      - name: Lint (shellcheck)
        run: make lint

      - name: Format check (shfmt)
        run: make fmt-check

      - name: Test (bats)
        run: make test

  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install shellcheck
        run: brew install shellcheck

      - name: Lint
        run: make lint

      - name: Test
        run: make test
